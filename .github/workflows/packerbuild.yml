name: Build AMI Packer

on: push

jobs:
  ami-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Environment Variables
        run: |
          touch .env
          echo "DEVDB=${{vars.DEVDB}}" >> .env
          echo "DEVPASSWORD=${{vars.DEVPASSWORD}}" >> .env
          echo "DEVUSERNAME=${{vars.DEVUSERNAME}}" >> .env
          echo "DEVHOST=${{vars.DEVHOST}}" >> .env

      # - name: Copy webapp files
      #   run: rsync -arv --exclude='.git/' --exclude='.github/' --exclude='.gitignore' . ./webapp && ls -R

      # - name: Create Directory (if needed)
      #   run: mkdir -p webapp 

      - name: creating a zip
        # uses: montudor/action-zip@v1
        run: zip -r webapp.zip .
      
      - name: AWS Configure
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
          aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          aws-region: us-east-2

      - name: Build AMI
        run: |
          packer init aws.pkr.hcl
          packer fmt aws.pkr.hcl
          packer validate aws.pkr.hcl
          packer build aws.pkr.hcl
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AMI_USER_DEMO: ${{secrets.AMI_USER_DEMO}} 
          PKR_VAR_aws_region: "${{ secrets.AWS_REGION }}"
          PKR_VAR_source_ami: "${{ vars.SOURCE_AMI }}"
          PKR_VAR_subnet_id: "${{ secrets.SUBNET_ID }}"
          PKR_VAR_ssh_username: "${{ secrets.SSH_USERNAME }}"
          PKR_VAR_aws_profile: "${{ secrets.aws_profile }}"